name: ðŸŽ­ Playwright Test Execution

on:
  workflow_dispatch:
    inputs:
      browsers:
        description: 'Browsers to test'
        required: false
        default: 'chromium'

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ§ Job 1: Ubuntu Latest Environment
  test-ubuntu:
    name: ðŸ§ Ubuntu Tests (ubuntu-latest)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ðŸ“¥ Checkout
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ðŸ”§ Setup Node.js
      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ðŸ“š Install npm dependencies
      - name: ðŸ“š Install npm dependencies
        run: npm ci

      # ðŸŽ­ Install Playwright browsers and deps
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps

      # ðŸ“Š Install Allure CLI
      - name: ðŸ“Š Install Allure CLI
        run: npm install -g allure-commandline

      # ðŸ§ª Run tests
      - name: ðŸ§ª Run Playwright Tests
        id: test-run
        run: |
          npx playwright test tests/check-motor-vehicle-stamp-duty.spec.ts \
            --reporter=list \
            --reporter=json \
            --reporter=junit \
            --reporter=allure-playwright
        continue-on-error: true

      # ðŸ“‹ Log test results
      - name: ðŸ“‹ Log test execution status
        id: check-results
        run: |
          if [ ${{ steps.test-run.outcome }} == 'failure' ]; then
            echo "TEST_FAILED=true" >> $GITHUB_ENV
            echo "::error::âŒ Tests failed on Ubuntu! Activating Healer..."
          else
            echo "TEST_FAILED=false" >> $GITHUB_ENV
            echo "::notice::âœ… All tests passed on Ubuntu!"
          fi

      # ðŸ”§ Healer - Log failures
      - name: ðŸ”§ Playwright Healer - Analyze Failures
        if: env.TEST_FAILED == 'true'
        id: healer
        run: |
          echo "::group::ðŸ”§ Playwright Healer - Ubuntu"
          echo "Analyzing test failures..."
          if [ -f test-results/results.json ]; then
            echo "Test results summary:"
            cat test-results/results.json | jq '.suites[0].specs[] | {title, status}' || true
          fi
          echo "Healer analysis complete"
          echo "::endgroup::"
        continue-on-error: true

      # ðŸ“Š Generate Allure Report
      - name: ðŸ“Š Generate Allure Report
        if: always()
        run: |
          if [ -d allure-results ]; then
            npx allure generate ./allure-results --clean -o ./allure-report || true
            echo "Allure report generated successfully"
          fi
        continue-on-error: true

      # ðŸ“ Archive Allure Results
      - name: ðŸ“ Archive Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-ubuntu
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“Š Archive Allure Reports
      - name: ðŸ“Š Archive Allure Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-ubuntu
          path: allure-report/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“ Archive Playwright Report
      - name: ðŸ“ Archive Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-ubuntu
          path: test-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ”§ Archive Healer Output
      - name: ðŸ”§ Archive Healer Output
        if: env.TEST_FAILED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: healer-output-ubuntu
          path: test-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“ Create Summary
      - name: ðŸ“ Create Test Summary - Ubuntu
        if: always()
        run: |
          echo "## ðŸ§ Ubuntu Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-run.outcome }}" == "success" ]; then
            echo "- âœ… Status: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ Healer: **ACTIVATED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸƒ Environment: Ubuntu Latest" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Test: Motor Vehicle Stamp Duty Calculator" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Reports: Playwright, Allure, JUnit" >> $GITHUB_STEP_SUMMARY

  # ðŸ³ Job 2: Official Playwright Docker Image
  test-docker:
    name: ðŸ³ Docker Tests (Playwright Official Image)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
      options: --user root

    steps:
      # ðŸ“¥ Checkout
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ðŸ”§ Setup Node environment
      - name: ðŸ”§ Setup Node environment
        run: |
          node --version
          npm --version
          npx playwright --version

      # ðŸ“š Install npm dependencies
      - name: ðŸ“š Install dependencies in Docker
        run: npm ci

      # ðŸ“Š Install Allure CLI
      - name: ðŸ“Š Install Allure CLI
        run: npm install -g allure-commandline

      # ðŸ§ª Run tests in Docker
      - name: ðŸ§ª Run Playwright Tests in Docker
        id: test-run
        run: |
          npx playwright test tests/check-motor-vehicle-stamp-duty.spec.ts \
            --reporter=list \
            --reporter=json \
            --reporter=junit \
            --reporter=allure-playwright
        continue-on-error: true

      # ðŸ“‹ Log test results from Docker
      - name: ðŸ“‹ Log test execution status
        id: check-results
        run: |
          if [ ${{ steps.test-run.outcome }} == 'failure' ]; then
            echo "TEST_FAILED=true" >> $GITHUB_ENV
            echo "::error::âŒ Tests failed in Docker! Activating Healer..."
          else
            echo "TEST_FAILED=false" >> $GITHUB_ENV
            echo "::notice::âœ… All tests passed in Docker!"
          fi

      # ðŸ”§ Healer - Log Docker failures
      - name: ðŸ”§ Playwright Healer - Analyze Docker Failures
        if: env.TEST_FAILED == 'true'
        id: healer
        run: |
          echo "::group::ðŸ”§ Playwright Healer - Docker"
          echo "Analyzing test failures in Docker..."
          if [ -f test-results/results.json ]; then
            echo "Test results summary:"
            cat test-results/results.json | jq '.suites[0].specs[] | {title, status}' || true
          fi
          echo "Healer analysis complete"
          echo "::endgroup::"
        continue-on-error: true

      # ðŸ“Š Generate Allure Report in Docker
      - name: ðŸ“Š Generate Allure Report
        if: always()
        run: |
          if [ -d allure-results ]; then
            npx allure generate ./allure-results --clean -o ./allure-report || true
            echo "Allure report generated successfully"
          fi
        continue-on-error: true

      # ðŸ“ Archive Allure Results from Docker
      - name: ðŸ“ Archive Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-docker
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“Š Archive Allure Reports from Docker
      - name: ðŸ“Š Archive Allure Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-docker
          path: allure-report/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“ Archive Playwright Report from Docker
      - name: ðŸ“ Archive Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-docker
          path: test-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ”§ Archive Healer Output from Docker
      - name: ðŸ”§ Archive Healer Output
        if: env.TEST_FAILED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: healer-output-docker
          path: test-results/
          if-no-files-found: ignore
          retention-days: 30

      # ðŸ“ Create Summary for Docker
      - name: ðŸ“ Create Test Summary - Docker
        if: always()
        run: |
          echo "## ðŸ³ Docker Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-run.outcome }}" == "success" ]; then
            echo "- âœ… Status: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ Healer: **ACTIVATED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸƒ Environment: Official Playwright Docker" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Image: mcr.microsoft.com/playwright:v1.58.2-noble" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Test: Motor Vehicle Stamp Duty Calculator" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Reports: Playwright, Allure, JUnit" >> $GITHUB_STEP_SUMMARY

